<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רשימת אריזה לטיול אורלנדו</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: white;
            --text-color: #333;
            --header-gradient-start: #ff6b6b;
            --header-gradient-end: #ee5a52;
            --category-bg: #f8f9ff;
            --category-border: #e1e8ff;
            --category-header-bg: #4c63d2;
            --stats-bg: #f8f9ff;
            --add-section-bg: #f0f8f0;
            --add-section-border: #c8e6c9;
            --shadow-color: rgba(0,0,0,0.1);
            --input-bg: white;
            --completed-bg: #f0f8f0;
        }
        
        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-color: #e8e8e8;
            --header-gradient-start: #e94560;
            --header-gradient-end: #c73650;
            --category-bg: #16213e;
            --category-border: #1a1a2e;
            --category-header-bg: #533483;
            --stats-bg: #16213e;
            --add-section-bg: #1a2643;
            --add-section-border: #2d4059;
            --shadow-color: rgba(0,0,0,0.3);
            --input-bg: #16213e;
            --completed-bg: #1a2e1a;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .auth-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
        }
        
        body.dark-mode .auth-section {
            background: var(--container-bg);
        }
        
        .auth-section img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .auth-info {
            flex: 1;
            min-width: 0;
        }
        
        .auth-name {
            font-weight: bold;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .auth-status {
            font-size: 0.8em;
            color: #666;
        }
        
        body.dark-mode .auth-status {
            color: #aaa;
        }
        
        .auth-status.editor {
            color: #4caf50;
        }
        
        .auth-status.viewer {
            color: #ff9800;
        }
        
        .sign-in-btn, .sign-out-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .sign-in-btn:hover, .sign-out-btn:hover {
            background: #357ae8;
            transform: scale(1.05);
        }
        
        .sign-out-btn {
            background: #db4437;
            padding: 6px 12px;
            font-size: 0.8em;
        }
        
        .sign-out-btn:hover {
            background: #c23321;
        }
        
        .view-only-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        body.dark-mode .view-only-banner {
            background: #3d3d00;
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.5em;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .sync-indicator.syncing {
            background: #ff9800;
        }
        
        .sync-indicator.error {
            background: #f44336;
        }
        
        .sync-indicator.hidden {
            transform: translateY(100px);
            opacity: 0;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sync-icon {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        .sync-indicator:not(.syncing) .sync-icon {
            animation: none;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 20px 40px var(--shadow-color);
            overflow: hidden;
            transition: all 0.3s ease;
            margin-top: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end));
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .reset-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,100,100,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            color: white;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            background: rgba(255,100,100,0.5);
            transform: scale(1.05);
        }
        
        .reset-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .progress {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: white;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .content {
            padding: 25px;
        }
        
        .category {
            background: var(--category-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--category-border);
            transition: all 0.3s ease;
        }
        
        .category-header {
            background: var(--category-header-bg);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
            transition: background 0.3s ease;
        }
        
        .category-header:hover {
            background: #3d52c1;
        }
        
        body.dark-mode .category-header:hover {
            background: #6b4ca3;
        }
        
        .category-header h3 {
            font-size: 1.2em;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }
        
        .category.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .category-content {
            padding: 20px;
            transition: all 0.3s ease;
            max-height: 2000px;
            overflow: hidden;
        }
        
        .category.collapsed .category-content {
            max-height: 0;
            padding: 0 20px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--category-border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .checklist-item:last-child {
            border-bottom: none;
        }
        
        .checklist-item.completed {
            opacity: 0.6;
            background: var(--completed-bg);
            text-decoration: line-through;
            border-radius: 6px;
            margin: 2px 0;
            padding: 12px 10px;
        }
        
        .checklist-item.view-only input[type="checkbox"] {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 15px;
            accent-color: #4c63d2;
            cursor: pointer;
        }
        
        .checklist-item label {
            flex: 1;
            cursor: pointer;
            font-size: 1.05em;
            line-height: 1.4;
        }
        
        .checklist-item.view-only label {
            cursor: default;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .checklist-item:hover .item-actions {
            opacity: 1;
        }
        
        .checklist-item.view-only .item-actions {
            display: none;
        }
        
        .edit-btn, .delete-btn, .save-btn, .cancel-btn {
            border: none;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            color: white;
        }
        
        .edit-btn {
            background: #4c63d2;
        }
        
        .edit-btn:hover {
            background: #3d52c1;
            transform: scale(1.05);
        }
        
        .delete-btn {
            background: #ff4757;
        }
        
        .delete-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }
        
        .save-btn {
            background: #4caf50;
        }
        
        .save-btn:hover {
            background: #45a049;
        }
        
        .cancel-btn {
            background: #666;
        }
        
        .cancel-btn:hover {
            background: #555;
        }
        
        .edit-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #4c63d2;
            border-radius: 6px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .stats {
            background: var(--stats-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid var(--category-border);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: var(--container-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4c63d2;
        }
        
        body.dark-mode .stat-number {
            color: #8b9aff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        body.dark-mode .stat-label {
            color: #aaa;
        }
        
        .person-tag {
            display: inline-block;
            background: #4c63d2;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }
        
        .add-item-section {
            background: var(--add-section-bg);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--add-section-border);
        }
        
        .add-item-section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .add-item-section h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        body.dark-mode .add-item-section h3 {
            color: #66bb6a;
        }
        
        .add-item-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .add-item-form select,
        .add-item-form input {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid var(--add-section-border);
            border-radius: 8px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .add-item-form select:focus,
        .add-item-form input:focus {
            outline: none;
            border-color: #4c63d2;
            box-shadow: 0 0 5px rgba(76, 99, 210, 0.3);
        }
        
        .add-item-form button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .add-item-form button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .add-item-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        body.dark-mode .footer {
            color: #999;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .auth-section {
                top: 10px;
                right: 10px;
                max-width: 200px;
            }
            
            .container {
                margin-top: 120px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .theme-toggle {
                top: 10px;
                left: 10px;
                padding: 6px 10px;
                font-size: 1em;
            }
            
            .reset-btn {
                top: 10px;
                right: 10px;
                font-size: 0.8em;
                padding: 6px 10px;
            }
            
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .add-item-form {
                flex-direction: column;
            }
            
            .add-item-form select,
            .add-item-form input,
            .add-item-form button {
                width: 100%;
                min-width: auto;
            }
            
            .sync-indicator {
                bottom: 10px;
                left: 10px;
                font-size: 0.8em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-section" id="authSection">
        <div id="authContent">
            <button class="sign-in-btn" onclick="signInWithGoogle()">כניסה עם Google</button>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div>⏳ טוען נתונים מהענן...</div>
    </div>
    
    <div class="sync-indicator hidden" id="syncIndicator">
        <span class="sync-icon">🔄</span>
        <span id="syncText">מסונכרן</span>
    </div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">🌙</button>
            <button class="reset-btn" onclick="resetAll()" id="resetBtn">🔄 אפס הכל</button>
            <h1>🏰 רשימת אריזה לטיול אורלנדו</h1>
            <p>משפחה של 5 • שבועיים • פארקי דיסני ויוניברסל</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <div class="content">
            <div class="view-only-banner hidden" id="viewOnlyBanner">
                👁️ מצב צפייה בלבד - התחבר עם חשבון Google מורשה כדי לערוך
            </div>
            
            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalItems">0</div>
                        <div class="stat-label">סה"כ פריטים</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedItems">0</div>
                        <div class="stat-label">נארז</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="remainingItems">0</div>
                        <div class="stat-label">נשאר</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completionPercentage">0%</div>
                        <div class="stat-label">הושלם</div>
                    </div>
                </div>
            </div>

            <!-- קטגוריות -->
            <div class="category" data-category="medical">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>💊 תרופות וציוד רפואי</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="medical-content"></div>
            </div>

            <div class="category" data-category="electronics">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>📱 ציוד אלקטרוניקה ומולטימדיה</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="electronics-content"></div>
            </div>

            <div class="category" data-category="parks">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>🎢 ציוד פארקים ופעילויות</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="parks-content"></div>
            </div>

            <div class="category" data-category="parents">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>👔 בגדים - הורים</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="parents-content"></div>
            </div>

            <div class="category" data-category="teen">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>🎧 בן/בת 17</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="teen-content"></div>
            </div>

            <div class="category" data-category="kid13">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>🎮 בן/בת 13</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="kid13-content"></div>
            </div>

            <div class="category" data-category="kid8">
                <div class="category-header" onclick="toggleCategory(this)">
                    <h3>🧸 בן/בת 8</h3>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="category-content" id="kid8-content"></div>
            </div>

            <!-- Add New Item Section -->
            <div class="add-item-section" id="addItemSection">
                <h3>➕ הוסף פריט חדש</h3>
                <div class="add-item-form">
                    <select id="categorySelect">
                        <option value="">בחר קטגוריה...</option>
                        <option value="medical">💊 תרופות וציוד רפואי</option>
                        <option value="electronics">📱 ציוד אלקטרוניקה ומולטימדיה</option>
                        <option value="parks">🎢 ציוד פארקים ופעילויות</option>
                        <option value="parents">👔 בגדים - הורים</option>
                        <option value="teen">🎧 בן/בת 17</option>
                        <option value="kid13">🎮 בן/בת 13</option>
                        <option value="kid8">🧸 בן/בת 8</option>
                    </select>
                    <input type="text" id="newItemText" placeholder="הכנס תיאור הפריט..." maxlength="100">
                    <button id="addItemBtn" onclick="addNewItem()">הוסף</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            ☁️ כל הנתונים נשמרים בענן ומסתנכרנים בין כל המכשירים
        </div>
    </div>

    <script>
        // YOUR Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVi8WSsnGHuBtpszcyAayUlCKve37x-nM",
            authDomain: "orlandopacking-b74ec.firebaseapp.com",
            databaseURL: "https://orlandopacking-b74ec-default-rtdb.firebaseio.com",
            projectId: "orlandopacking-b74ec",
            storageBucket: "orlandopacking-b74ec.firebasestorage.app",
            messagingSenderId: "478421714168",
            appId: "1:478421714168:web:debfb7279164c6eb39a70d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // User state
        let currentUser = null;
        let isEditor = false;

        // Default items
        const defaultItems = {
            medical: [
                'תרופות קבועות לכל בני המשפחה (כמות ל-3 שבועות + רזרבה)',
                'מרשמים רפואיים מקוריים',
                'פלסטרים ותחבושות',
                'משכך כאבים (פרצטמול, אדוויל)',
                'תרופות לקלקול קיבה',
                'קרם הגנה SPF 50+ (מספר יחידות)',
                'קרם לאחר שיזוף/אלווורה'
            ],
            electronics: [
                'מטענים לכל המכשירים',
                'מטען נייד (Power Bank) גדול',
                'כבל מתאם חשמל אמריקאי',
                'מפצל חשמל (Power Strip)',
                'אוזניות לכל אחד',
                'כבלים נוספים (USB-C, Lightning)',
                'נרתיק עמיד למים לטלפונים'
            ],
            parks: [
                'תיקי גב קטנים לפארקים',
                'בקבוקי מים לשימוש חוזר (5 יח\')',
                'מאווררים ידניים/חשמליים קטנים',
                'כובעים וכובעי מצחייה',
                'משקפי שמש לכולם',
                'טישו ומטליות לחות'
            ],
            parents: [
                '<span class="person-tag">הורה 1</span>חולצות טי שירט (8-10 יח\')',
                '<span class="person-tag">הורה 1</span>מכנסיים קצרים (6-7 יח\')',
                '<span class="person-tag">הורה 1</span>בגדי ים (2-3 יח\')',
                '<span class="person-tag">הורה 1</span>נעליים נוחות להליכה (2 זוגות)',
                '<span class="person-tag">הורה 2</span>חולצות טי שירט (8-10 יח\')',
                '<span class="person-tag">הורה 2</span>מכנסיים קצרים (6-7 יח\')',
                '<span class="person-tag">הורה 2</span>בגדי ים (2-3 יח\')',
                '<span class="person-tag">הורה 2</span>נעליים נוחות להליכה (2 זוגות)'
            ],
            teen: [
                'חולצות טי שירט (8-9 יח\')',
                'מכנסיים קצרים (6 יח\')',
                'בגדי ים (2-3 יח\')',
                'נעליים נוחות + סניקרס',
                'טלפון + מטען + אוזניות',
                'מצלמה אישית/GoPro'
            ],
            kid13: [
                'חולצות טי שירט (7-8 יח\')',
                'מכנסיים קצרים (5-6 יח\')',
                'בגדי ים (2 יח\')',
                'נעליים נוחות + כפכפים',
                'טלפון + מטען + אוזניות',
                'קונסולת Nintendo Switch + משחקים'
            ],
            kid8: [
                'חולצות טי שירט (6-7 יח\')',
                'מכנסיים קצרים (5 יח\')',
                'בגדי ים (2 יח\')',
                'פיג\'מות (3-4 יח\')',
                'טאבלט + מגן + אוזניות לילדים',
                'צעצועים קטנים + ספרי צביעה',
                'רכב צעצוע/בובה אהובה'
            ]
        };

        let items = {};
        let checkedItems = {};
        let isInitialized = false;
        let editors = {};

        // Google Sign-In
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                console.log('Signed in:', result.user.email);
                // Don't call checkUserPermissions here - onAuthStateChanged will handle it
            }).catch((error) => {
                console.error('Sign-in error:', error);
                if (error.code === 'auth/unauthorized-domain') {
                    showSyncStatus('error', 'דומיין לא מורשה - נא להוסיף ב-Firebase Console או להשתמש ב-localhost');
                    alert('כדי להשתמש בהתחברות, יש להוסיף את הדומיין הנוכחי ברשימת הדומיינים המורשים ב-Firebase Console.\n\nלחלופין, הפעל שרת מקומי:\npython -m http.server 8000\n\nואז גש ל: http://localhost:8000');
                } else {
                    showSyncStatus('error', 'שגיאה בהתחברות');
                }
            });
        }

        // Sign out
        function signOut() {
            auth.signOut().then(() => {
                console.log('Signed out');
                location.reload();
            }).catch((error) => {
                console.error('Sign-out error:', error);
            });
        }

        // Check user permissions
        function checkUserPermissions(user) {
            if (!user || !user.email) {
                isEditor = false;
                updateUIForPermissions();
                return;
            }

            const emailKey = user.email.replace('@', '_').replace(/\./g, '-');
            console.log('Checking permissions for:', user.email, 'with key:', emailKey);

            // Check if user is in editors list
            database.ref(`editors/${emailKey}`).once('value').then((snapshot) => {
                console.log('Editor status from database:', snapshot.val());
                isEditor = snapshot.val() === true;
                console.log('isEditor set to:', isEditor);
                updateUIForPermissions();
                updateAuthUI(user); // Update auth UI AFTER we know the editor status

                if (isEditor) {
                    showSyncStatus('success', 'התחברת כעורך');
                } else {
                    showSyncStatus('success', 'התחברת כצופה');

                    // Add instruction for becoming an editor
                    console.log('To become an editor, run in console: makeEditor("' + user.email + '")');
                }
            }).catch((error) => {
                console.error('Error checking permissions:', error);
            });
        }

        // Function to make a user an editor (run in console)
        function makeEditor(email) {
            if (!email) {
                console.error('Please provide an email address');
                return;
            }

            const emailKey = email.replace('@', '_').replace(/\./g, '-');
            console.log('Attempting to add editor with key:', emailKey);

            database.ref(`editors/${emailKey}`).set(true).then(() => {
                console.log('Successfully added', email, 'as editor');
                alert('המשתמש ' + email + ' הוגדר כעורך! יש לרענן את הדף.');

                // Verify it was written
                database.ref(`editors/${emailKey}`).once('value').then((snapshot) => {
                    console.log('Verification - Editor status in database:', snapshot.val());
                    if (snapshot.val() === true) {
                        console.log('Editor permission confirmed in database');
                        location.reload();
                    } else {
                        console.error('Editor permission was not saved properly');
                    }
                });
            }).catch((error) => {
                console.error('Error adding editor:', error);
                alert('שגיאה בהוספת עורך: ' + error.message);
            });
        }

        // Update UI based on permissions
        function updateUIForPermissions() {
            const viewOnlyBanner = document.getElementById('viewOnlyBanner');
            const addItemSection = document.getElementById('addItemSection');
            const resetBtn = document.getElementById('resetBtn');

            console.log('Updating UI for permissions. isEditor:', isEditor, 'currentUser:', currentUser?.email);

            if (isEditor) {
                viewOnlyBanner?.classList.add('hidden');
                addItemSection?.classList.remove('disabled');
                if (resetBtn) resetBtn.disabled = false;

                // Enable all checkboxes and actions
                document.querySelectorAll('.checklist-item').forEach(item => {
                    item.classList.remove('view-only');
                });
            } else {
                if (currentUser) {
                    viewOnlyBanner?.classList.remove('hidden');
                } else {
                    viewOnlyBanner?.classList.add('hidden');
                }
                addItemSection?.classList.add('disabled');
                if (resetBtn) resetBtn.disabled = true;

                // Disable all checkboxes and actions
                document.querySelectorAll('.checklist-item').forEach(item => {
                    item.classList.add('view-only');
                });
            }

            // Force re-render of all items to show/hide edit buttons
            if (isEditor && typeof renderAllItems !== 'undefined') {
                renderAllItems();
            }
        }

        // Update auth UI
        function updateAuthUI(user) {
            const authContent = document.getElementById('authContent');
            
            if (user) {
                const statusClass = isEditor ? 'editor' : 'viewer';
                const statusText = isEditor ? 'עורך' : 'צופה';
                
                authContent.innerHTML = `
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User')}" alt="Profile">
                    <div class="auth-info">
                        <div class="auth-name">${user.displayName || user.email}</div>
                        <div class="auth-status ${statusClass}">${statusText}</div>
                    </div>
                    <button class="sign-out-btn" onclick="signOut()">יציאה</button>
                `;
            } else {
                authContent.innerHTML = `
                    <button class="sign-in-btn" onclick="signInWithGoogle()">כניסה עם Google</button>
                `;
            }
        }

        // Show sync status
        function showSyncStatus(status, message) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            
            indicator.classList.remove('hidden', 'syncing', 'error');
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
                text.textContent = message || 'מסנכרן...';
            } else if (status === 'error') {
                indicator.classList.add('error');
                text.textContent = message || 'שגיאה בסנכרון';
            } else {
                text.textContent = message || 'מסונכרן';
            }
            
            setTimeout(() => {
                if (!indicator.classList.contains('syncing')) {
                    indicator.classList.add('hidden');
                }
            }, 3000);
        }

        // Initialize app with Firebase
        async function initializeApp() {
            // Check for admin setup mode
            const urlParams = new URLSearchParams(window.location.search);
            const setupMode = urlParams.get('setup');

            // Listen to authentication state
            auth.onAuthStateChanged((user) => {
                currentUser = user;

                if (user) {
                    console.log('User signed in:', user.email);

                    // Auto-grant editor permissions if in setup mode
                    if (setupMode === 'editor' && user.email) {
                        makeEditor(user.email);
                    } else {
                        checkUserPermissions(user); // This will call updateAuthUI after checking permissions
                    }
                } else {
                    console.log('No user signed in - anonymous mode');
                    isEditor = false;
                    updateAuthUI(null); // Only update auth UI for non-authenticated state
                    updateUIForPermissions();
                }

                if (!isInitialized) {
                    setupDatabaseListeners();
                }
            });
        }

        // Setup database listeners
        function setupDatabaseListeners() {
            // Listen for items changes
            database.ref('items').on('value', (snapshot) => {
                const data = snapshot.val();
                items = data || defaultItems;
                
                if (!isInitialized) {
                    // First time - check if we need to initialize with defaults
                    if (!data) {
                        database.ref('items').set(defaultItems);
                    }
                }
                
                renderAllItems();
                updateStats();
                if (isInitialized) {
                    showSyncStatus('success', 'עודכן מהענן');
                }
            });

            // Listen for checked items changes
            database.ref('checkedItems').on('value', (snapshot) => {
                checkedItems = snapshot.val() || {};
                if (isInitialized) {
                    updateCheckboxes();
                    updateStats();
                }
            });

            // Listen for editors list changes
            database.ref('editors').on('value', (snapshot) => {
                editors = snapshot.val() || {};
                if (currentUser) {
                    checkUserPermissions(currentUser);
                }
            });

            // Listen for theme preference
            database.ref('preferences/theme').on('value', (snapshot) => {
                const theme = snapshot.val() || 'light';
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('themeToggle').textContent = '🌙';
                }
            });

            // Listen for collapsed categories
            database.ref('preferences/collapsed').on('value', (snapshot) => {
                const collapsed = snapshot.val() || [];
                collapsed.forEach(categoryName => {
                    const category = document.querySelector(`[data-category="${categoryName}"]`);
                    if (category) {
                        category.classList.add('collapsed');
                    }
                });
            });

            // Mark as initialized and hide loading
            setTimeout(() => {
                isInitialized = true;
                document.getElementById('loadingOverlay').classList.add('hidden');
                showSyncStatus('success', 'מחובר לענן');
                updateUIForPermissions();
            }, 1000);
        }

        // Render all items
        function renderAllItems() {
            Object.keys(items).forEach(category => {
                renderCategoryItems(category);
            });
        }

        // Render category items
        function renderCategoryItems(category) {
            const container = document.getElementById(`${category}-content`);
            if (!container) return;

            container.innerHTML = '';
            
            if (items[category]) {
                items[category].forEach((itemText, index) => {
                    const itemId = `${category}-${index}`;
                    const isChecked = checkedItems[itemId] || false;
                    const itemElement = createItemElement(itemText, itemId, isChecked, category, index);
                    container.appendChild(itemElement);
                });
            }
        }

        // Create item element
        function createItemElement(text, itemId, isChecked, category, index) {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            if (!isEditor) {
                div.classList.add('view-only');
            }
            if (isChecked) {
                div.classList.add('completed');
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = itemId;
            checkbox.checked = isChecked;
            checkbox.addEventListener('change', function() {
                if (isEditor) {
                    handleCheckChange(this, itemId);
                } else {
                    this.checked = !this.checked; // Revert change
                    alert('התחבר עם חשבון מורשה כדי לערוך');
                }
            });

            const label = document.createElement('label');
            label.htmlFor = itemId;
            label.innerHTML = text;

            const actions = document.createElement('div');
            actions.className = 'item-actions';

            if (isEditor) {
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'ערוך';
                editBtn.onclick = () => editItem(category, index, div);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'מחק';
                deleteBtn.onclick = () => deleteItem(category, index);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
            }

            div.appendChild(checkbox);
            div.appendChild(label);
            if (isEditor) {
                div.appendChild(actions);
            }

            return div;
        }

        // Handle checkbox change
        function handleCheckChange(checkbox, itemId) {
            if (!isEditor) {
                checkbox.checked = !checkbox.checked;
                alert('התחבר עם חשבון מורשה כדי לערוך');
                return;
            }

            showSyncStatus('syncing', 'שומר...');
            
            const item = checkbox.closest('.checklist-item');
            const updates = {};
            
            if (checkbox.checked) {
                item.classList.add('completed');
                updates[`checkedItems/${itemId}`] = true;
            } else {
                item.classList.remove('completed');
                updates[`checkedItems/${itemId}`] = null;
            }
            
            database.ref().update(updates).then(() => {
                showSyncStatus('success', 'נשמר');
            }).catch((error) => {
                showSyncStatus('error', 'שגיאה בשמירה');
                console.error('Save error:', error);
                checkbox.checked = !checkbox.checked; // Revert on error
            });
            
            updateStats();
        }

        // Update checkboxes after data sync
        function updateCheckboxes() {
            document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
                const itemId = checkbox.id;
                const isChecked = checkedItems[itemId] || false;
                checkbox.checked = isChecked;
                
                const item = checkbox.closest('.checklist-item');
                if (isChecked) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });
        }

        // Edit item
        function editItem(category, index, itemElement) {
            if (!isEditor) {
                alert('התחבר עם חשבון מורשה כדי לערוך');
                return;
            }

            const label = itemElement.querySelector('label');
            const currentText = label.innerHTML;
            
            // Remove person tags for editing
            const textWithoutTags = currentText.replace(/<span class="person-tag">.*?<\/span>/g, '');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = textWithoutTags;

            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-btn';
            saveBtn.textContent = 'שמור';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-btn';
            cancelBtn.textContent = 'בטל';

            const actions = itemElement.querySelector('.item-actions');
            actions.style.opacity = '1';
            actions.innerHTML = '';
            actions.appendChild(saveBtn);
            actions.appendChild(cancelBtn);

            label.style.display = 'none';
            itemElement.insertBefore(input, actions);
            input.focus();
            input.select();

            const saveEdit = () => {
                const newText = input.value.trim();
                if (newText) {
                    showSyncStatus('syncing', 'שומר...');
                    database.ref(`items/${category}/${index}`).set(newText).then(() => {
                        showSyncStatus('success', 'נשמר');
                    }).catch((error) => {
                        showSyncStatus('error', 'שגיאה בשמירה');
                    });
                }
            };

            const cancelEdit = () => {
                renderCategoryItems(category);
                updateStats();
            };

            saveBtn.onclick = saveEdit;
            cancelBtn.onclick = cancelEdit;
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        // Delete item
        function deleteItem(category, index) {
            if (!isEditor) {
                alert('התחבר עם חשבון מורשה כדי למחוק');
                return;
            }

            if (confirm('האם אתה בטוח שברצונך למחוק פריט זה?')) {
                showSyncStatus('syncing', 'מוחק...');
                
                // Get current items for category
                const categoryItems = [...(items[category] || [])];
                categoryItems.splice(index, 1);
                
                // Update items
                database.ref(`items/${category}`).set(categoryItems).then(() => {
                    // Update checked items (reindex)
                    const updates = {};
                    Object.keys(checkedItems).forEach(key => {
                        const [cat, idx] = key.split('-');
                        if (cat === category) {
                            const numIdx = parseInt(idx);
                            if (numIdx === index) {
                                updates[`checkedItems/${key}`] = null;
                            } else if (numIdx > index) {
                                updates[`checkedItems/${key}`] = null;
                                updates[`checkedItems/${cat}-${numIdx - 1}`] = checkedItems[key];
                            }
                        }
                    });
                    
                    return database.ref().update(updates);
                }).then(() => {
                    showSyncStatus('success', 'נמחק');
                }).catch((error) => {
                    showSyncStatus('error', 'שגיאה במחיקה');
                    console.error('Delete error:', error);
                });
            }
        }

        // Add new item
        function addNewItem() {
            if (!isEditor) {
                alert('התחבר עם חשבון מורשה כדי להוסיף פריטים');
                return;
            }

            const categorySelect = document.getElementById('categorySelect');
            const itemText = document.getElementById('newItemText');
            
            if (!categorySelect.value || !itemText.value.trim()) {
                alert('אנא בחר קטגוריה והכנס תיאור לפריט');
                return;
            }
            
            const category = categorySelect.value;
            const text = itemText.value.trim();
            
            showSyncStatus('syncing', 'מוסיף...');
            
            // Get current items for category
            const categoryItems = items[category] || [];
            categoryItems.push(text);
            
            // Save to database
            database.ref(`items/${category}`).set(categoryItems).then(() => {
                // Clear form
                categorySelect.value = '';
                itemText.value = '';
                
                // Expand category if collapsed
                const categoryElement = document.querySelector(`[data-category="${category}"]`);
                if (categoryElement && categoryElement.classList.contains('collapsed')) {
                    categoryElement.classList.remove('collapsed');
                    saveCollapsedState();
                }
                
                showSyncStatus('success', 'נוסף');
            }).catch((error) => {
                showSyncStatus('error', 'שגיאה בהוספה');
                console.error('Add error:', error);
            });
        }

        // Toggle category collapse
        function toggleCategory(header) {
            const category = header.closest('.category');
            category.classList.toggle('collapsed');
            if (isEditor) {
                saveCollapsedState();
            }
        }

        // Save collapsed state
        function saveCollapsedState() {
            if (!isEditor) return;
            
            const collapsed = [];
            document.querySelectorAll('.category.collapsed').forEach(cat => {
                const categoryName = cat.dataset.category;
                if (categoryName) {
                    collapsed.push(categoryName);
                }
            });
            database.ref('preferences/collapsed').set(collapsed);
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                themeToggle.textContent = '🌙';
                if (isEditor) {
                    database.ref('preferences/theme').set('light');
                }
            } else {
                body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
                if (isEditor) {
                    database.ref('preferences/theme').set('dark');
                }
            }
        }

        // Reset all data
        function resetAll() {
            if (!isEditor) {
                alert('התחבר עם חשבון מורשה כדי לאפס');
                return;
            }

            if (confirm('האם אתה בטוח שברצונך לאפס את כל הרשימה? פעולה זו תמחק את כל הסימונים והפריטים המותאמים אישית.')) {
                showSyncStatus('syncing', 'מאפס...');
                
                const updates = {
                    'items': defaultItems,
                    'checkedItems': null,
                    'preferences/collapsed': null
                };
                
                database.ref().update(updates).then(() => {
                    showSyncStatus('success', 'אופס בהצלחה');
                    location.reload();
                }).catch((error) => {
                    showSyncStatus('error', 'שגיאה באיפוס');
                    console.error('Reset error:', error);
                });
            }
        }

        // Update statistics
        function updateStats() {
            const allCheckboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]:checked');
            
            const total = allCheckboxes.length;
            const completed = checkedCheckboxes.length;
            const remaining = total - completed;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('completedItems').textContent = completed;
            document.getElementById('remainingItems').textContent = remaining;
            document.getElementById('completionPercentage').textContent = percentage + '%';
            
            // Update progress bar
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // Add enter key listener for new item input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newItemText').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && isEditor) {
                    addNewItem();
                }
            });
            
            // Initialize the app
            initializeApp();
        });
    </script>
</body>
</html>
